---
import { getCollection, render } from "astro:content";
import { getCourseStructure, getCourseTitle } from "../../lib/courses";
import Course from "../../layouts/Course.astro";

export async function getStaticPaths() {
  const lessons = await getCollection("courses");
  const availableLessons = lessons.filter((l) => !l.data.comingSoon);
  
  // Generate paths for individual lessons
  const lessonPaths = availableLessons.map((lesson) => ({
    params: { slug: lesson.id },
    props: { lesson, isRedirect: false },
  }));
  
  // Generate redirect paths for course-only slugs
  const courses = new Set(availableLessons.map(l => l.id.split('/')[0]));
  const coursePaths = [...courses].map(course => {
    const firstLesson = availableLessons
      .filter(l => l.id.startsWith(course + '/'))
      .sort((a, b) => a.data.order - b.data.order)[0];
    return {
      params: { slug: course },
      props: { lesson: firstLesson, isRedirect: true },
    };
  });
  
  return [...lessonPaths, ...coursePaths];
}

type Props = {
  lesson: Awaited<ReturnType<typeof getCollection<"courses">>>[number];
  isRedirect: boolean;
};

const { lesson, isRedirect } = Astro.props;

// Handle course-only redirects
if (isRedirect) {
  return Astro.redirect(`/courses/${lesson.id}`);
}
const { Content } = await render(lesson);

// Extract course slug first (needed for sidebar filtering)
const courseSlug = lesson.id.split("/")[0];
const courseTitle = getCourseTitle(courseSlug);

// Get sections for THIS course only
const sections = await getCourseStructure(courseSlug);

// Find next lesson within this course (only available lessons)
const allLessons = sections.flatMap((s) => s.lessons.filter(l => !l.data.comingSoon));
const currentIndex = allLessons.findIndex((l) => l.id === lesson.id);
const nextLesson =
  currentIndex >= 0 && currentIndex < allLessons.length - 1
    ? allLessons[currentIndex + 1]
    : null;
---

<Course
  title={lesson.data.title}
  description={lesson.data.description}
  sectionTitle={lesson.data.section}
  sections={sections}
  currentSlug={lesson.id}
  nextLesson={nextLesson}
  isWorksheet={lesson.data.isWorksheet}
  courseTitle={courseTitle}
>
  <Content />
</Course>
