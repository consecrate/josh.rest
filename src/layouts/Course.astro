---
import Base from "./Base.astro";
import CourseSidebar from "../components/CourseSidebar.astro";
import type { CourseSection } from "../lib/courses";
import type { CollectionEntry } from "astro:content";

interface Props {
  title: string;
  description?: string;
  sectionTitle?: string;
  sections: CourseSection[];
  currentSlug: string;
  nextLesson?: CollectionEntry<"courses"> | null;
}

const {
  title,
  description = "josh.rest — Interactive learning",
  sectionTitle,
  sections,
  currentSlug,
  nextLesson,
} = Astro.props;
---

<Base title={`${title} — josh.rest`} description={description} fullWidth>
  <div class="course-layout" id="course-layout">
    <CourseSidebar sections={sections} currentSlug={currentSlug} />
    <div class="sidebar-toggle-wrapper">
      <button
        class="sidebar-toggle"
        id="sidebar-toggle"
        title="Toggle Course Sidebar"
      >
        <svg
          class="toggle-icon"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M15 18l-6-6 6-6"></path>
        </svg>
      </button>
    </div>
    <main class="course-content">
      <div class="content-wrapper">
        <header class="lesson-header">
          {sectionTitle && <span class="section-name">{sectionTitle}</span>}
          <h1>{title}</h1>
        </header>
        <article class="lesson-content">
          <slot />
        </article>
        {
          nextLesson && (
            <div class="chapter-complete">
              <p class="complete-text">You've completed this chapter</p>
              <a href={`/courses/${nextLesson.id}`} class="keep-learning">
                Keep learning <span class="arrow">›</span>
              </a>
            </div>
          )
        }
      </div>
    </main>
  </div>
</Base>

<script>
  const layout = document.getElementById("course-layout");
  const toggle = document.getElementById("sidebar-toggle");

  toggle?.addEventListener("click", () => {
    layout?.classList.toggle("sidebar-collapsed");
  });
</script>

<style>
  .course-layout {
    display: flex;
    min-height: 100vh;
    position: relative;
  }

  .course-layout.sidebar-collapsed :global(.course-sidebar) {
    width: 0;
    border-right: none;
  }

  .course-layout.sidebar-collapsed :global(.sidebar-content) {
    opacity: 0;
    pointer-events: none;
  }

  .sidebar-toggle-wrapper {
    position: sticky;
    top: 0;
    height: 100vh;
    width: 0;
    z-index: 20;
  }

  .sidebar-toggle {
    position: absolute;
    left: -12px;
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 24px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 4px;
    background: #1b1912;
    color: var(--muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: left 0.2s ease;
  }

  .course-layout.sidebar-collapsed .sidebar-toggle {
    left: 12px;
  }

  .sidebar-toggle:hover {
    background: var(--surface);
    color: var(--text);
  }

  .toggle-icon {
    width: 14px;
    height: 14px;
    transition: transform 0.2s ease;
  }

  .course-layout.sidebar-collapsed .toggle-icon {
    transform: rotate(180deg);
  }

  .course-content {
    flex: 1;
    overflow-y: auto;
  }

  .content-wrapper {
    max-width: 720px;
    margin: 0 auto;
    padding: var(--space-2xl) var(--space-xl);
  }

  .lesson-header {
    margin-bottom: var(--space-2xl);
  }

  .section-name {
    display: block;
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: var(--space-sm);
  }

  .lesson-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0;
  }

  .lesson-content {
    line-height: 1.8;
  }

  .chapter-complete {
    margin-top: var(--space-2xl);
    padding: var(--space-lg);
    background: var(--surface);
    border-radius: 8px;
  }

  .complete-text {
    margin: 0 0 var(--space-sm);
    color: var(--text);
  }

  .keep-learning {
    color: var(--accent);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .keep-learning:hover {
    text-decoration: underline;
  }

  .arrow {
    font-size: 1.2em;
  }

  /* Mobile */
  @media (max-width: 900px) {
    .sidebar-toggle-wrapper {
      display: none;
    }

    .content-wrapper {
      padding: var(--space-lg);
    }

    .lesson-header h1 {
      font-size: 1.8rem;
    }
  }
</style>
