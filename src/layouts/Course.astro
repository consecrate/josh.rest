---
import Base from "./Base.astro";
import CourseSidebar from "../components/CourseSidebar.astro";
import CopyButton from "../components/CopyButton.astro";
import type { CourseSection } from "../lib/courses";
import type { CollectionEntry } from "astro:content";

interface Props {
  title: string;
  description?: string;
  sectionTitle?: string;
  sections: CourseSection[];
  currentSlug: string;
  nextLesson?: CollectionEntry<"courses"> | null;
  isWorksheet?: boolean;
}

const {
  title,
  description = "josh.rest — Interactive learning",
  sectionTitle,
  sections,
  currentSlug,
  nextLesson,
  isWorksheet = false,
} = Astro.props;
---

<Base title={`${title} — josh.rest`} description={description} fullWidth>
  <div class="course-layout">
    <CourseSidebar sections={sections} currentSlug={currentSlug} />
    <main class="course-content">
      <div class="content-wrapper">
        {!isWorksheet && (
          <header class="lesson-header">
            {sectionTitle && <span class="section-name">{sectionTitle}</span>}
            <h1>{title}</h1>
          </header>
        )}
        <article class="lesson-content">
          <slot />
        </article>
        {
          nextLesson && (
            <div class="chapter-complete">
              <p class="complete-text">You've completed this chapter</p>
              <a href={`/courses/${nextLesson.id}`} class="keep-learning">
                Keep learning <span class="arrow">›</span>
              </a>
            </div>
          )
        }
      </div>
    </main>
    <CopyButton />
  </div>
</Base>

<style>
  .course-layout {
    display: flex;
    min-height: 100vh;
  }

  .course-content {
    flex: 1;
    overflow-y: auto;
  }

  .content-wrapper {
    max-width: 720px;
    margin: 0 auto;
    padding: var(--space-2xl) var(--space-xl);
  }

  .lesson-header {
    margin-bottom: var(--space-2xl);
  }

  .section-name {
    display: block;
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: var(--space-sm);
  }

  .lesson-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0;
  }

  .lesson-content {
    line-height: 1.8;
  }

  .chapter-complete {
    margin-top: var(--space-2xl);
    padding: var(--space-lg);
    background: var(--surface);
    border-radius: 8px;
  }

  .complete-text {
    margin: 0 0 var(--space-sm);
    color: var(--text);
  }

  .keep-learning {
    color: var(--accent);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .keep-learning:hover {
    text-decoration: underline;
  }

  .arrow {
    font-size: 1.2em;
  }

  /* Mobile */
  @media (max-width: 900px) {
    .content-wrapper {
      padding: var(--space-lg);
    }

    .lesson-header h1 {
      font-size: 1.8rem;
    }
  }
</style>

<script>
  // Mobile scroll-hide behavior for floating buttons (Apple-style pattern)
  // Buttons hide when scrolling down, show when scrolling up
  function initMobileScrollHide() {
    const SCROLL_THRESHOLD = 10; // Minimum scroll to trigger
    const IDLE_TIMEOUT = 2000; // Hide after 2s idle
    
    let lastScrollY = window.scrollY;
    let ticking = false;
    let idleTimer: number | null = null;
    
    const copyBtn = document.getElementById('copy-lesson-btn');
    const menuBtn = document.querySelector('.mobile-menu-btn') as HTMLElement | null;
    
    // Only run on mobile
    const isMobile = () => window.matchMedia('(max-width: 900px)').matches;
    
    function hideButtons() {
      copyBtn?.classList.add('scroll-hidden');
      menuBtn?.classList.add('scroll-hidden');
    }
    
    function showButtons() {
      copyBtn?.classList.remove('scroll-hidden');
      menuBtn?.classList.remove('scroll-hidden');
    }
    
    function resetIdleTimer() {
      if (idleTimer) clearTimeout(idleTimer);
      idleTimer = window.setTimeout(() => {
        if (isMobile()) hideButtons();
      }, IDLE_TIMEOUT);
    }
    
    function onScroll() {
      if (!isMobile()) {
        showButtons();
        return;
      }
      
      const currentScrollY = window.scrollY;
      const delta = currentScrollY - lastScrollY;
      
      // Only trigger on meaningful scroll
      if (Math.abs(delta) > SCROLL_THRESHOLD) {
        if (delta > 0) {
          // Scrolling down - hide
          hideButtons();
        } else {
          // Scrolling up - show
          showButtons();
        }
        lastScrollY = currentScrollY;
      }
      
      // Reset idle timer
      resetIdleTimer();
      ticking = false;
    }
    
    window.addEventListener('scroll', () => {
      if (!ticking) {
        requestAnimationFrame(onScroll);
        ticking = true;
      }
    }, { passive: true });
    
    // Show on touch start (user interaction)
    window.addEventListener('touchstart', () => {
      if (isMobile()) {
        showButtons();
        resetIdleTimer();
      }
    }, { passive: true });
    
    // Initialize: start idle timer on mobile
    if (isMobile()) {
      resetIdleTimer();
    }
  }
  
  // Initialize on DOM ready and view transitions
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMobileScrollHide);
  } else {
    initMobileScrollHide();
  }
</script>

